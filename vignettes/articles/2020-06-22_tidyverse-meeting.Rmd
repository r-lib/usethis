---
title: "2020-06-22_tidyverse-meeting"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
pkgload::unload("devtools")
devtools::load_all("~/rrr/usethis")
attachNamespace("devtools")
```

## usethis in context

* Was created as part of the devtools "conscious uncoupling"
* Filesystem chores and workflow helpers for project and package development
* Including some Git / GitHub helpers

## Greatest Hits of Git/GitHub in usethis

```{r eval = FALSE}
create_from_github("OWNER/REPO", fork = NA/TRUE/FALSE)

use_github()

git_sitrep()

pr_init() / pr_fetch() etc.

use_github_release()
use_release_issue()

use_tidy_github_actions()
```

## Where we get Git functionality

* RStudio IDE shells out to command line Git
* usethis uses git2r (up 'til now)
* usethis uses gert (going forward)

gert maintained by Jeroen Ooms
https://github.com/r-lib/gert

Discussion point:
gert and credentials live in some weird joint r-lib / rOpenSci world
bit of diplomacy needed

## git2r and gert: what they have in common

Both wrap libgit2

> libgit2 is a portable, pure C implementation of the Git core methods provided
> as a re-entrant linkable library with a solid API, allowing you to write
> native speed custom Git applications in any language which supports C bindings

!!! Command line Git does NOT use libgit2 !!!

But GitHub, GitLab, Bitbucket, GitKraken, etc. all use libgit2

## git2r and gert: how they differ, 1 of 2

git2r (in theory) links against system libgit2 but also embeds libgit2 (think: stringi, readxl)

gert always links to system libgit2 statically (built on Windows via rtools40, built on macOS via Homebrew) or dynamically (linux)

Discussion topic: When to embed vs. link?
Embed *feels* like you're taking pain/work off the user
BUT only if you can really, totally shield them from pain

This has NOT been the case for git2r/libgit2. Why not?

Building libgit2 and, specifically, getting SSH/TLS capability requires platform-specific flags and other system dependencies.

There are lots of ways for things to go wrong.
And BOY HOWDY they went wrong A LOT.

The binaries produced by CRAN often result in git2r NOT having SSH capability:

```{r eval = FALSE}
Error in git2r::fetch(repo, name = remref_remote(remref), credentials = credentials,  : 
  Error in 'git2r_remote_fetch': unsupported URL protocol
```

Bottom line: Yes, you (may) have to explicitly install libgit2, but after that
gert "just works". HALLELUJAH!

## git2r and gert: how they differ, 2 of 2

git2r, in theory, can auto-discover credentials

In reality, that almost never worked

Therefore, you need to provide explicit credentials in every single call:

```{r eval = FALSE}
git2r::clone(
  origin_url,
  repo_path,
  credentials = credentials    # <----- THIS, EVERYWHERE, ALL THE TIME :(
)
```

This meant that usethis had to implement a Git Credential Valet Service

Jeroen solved this a much better way:

credentials = https://github.com/r-lib/credentials

* Separate package *just* for credential handling
* Very chatty and transparent and debuggable
* Uses os-specific, official Git credential store

Discussion point:
HTTPS + PAT is by far the best plan for most people
(Show slide here)
1) PAT works for GitHub API and conventional git remote operations
   two birds with 1 stone (actually n birds)
2) credentials + gert reliably auto-discovers and uses PAT
   bypasses Windows agony of "where is the home directory? where are the keys?"
   
usethis is losing (deprecating) its Git Credential Valet Service

## I will judge your GitHub remote configuration

usethis's GitHub functions often debuted in a form where would only work for
Hadley or for Jenny :(

Why? Assumptions about how GitHub remotes are configured

tidyverse dev days also reveal a great and wondrous variety of weird places
people get themselves into

I am also straightening this out while doing git2r --> gert

Formal infrastructure around recognizing GitHub remote configs as:

* Unsupported. And hopeless. Error.
* Supported. Peculiar. Interactive friction and nudges to fix.
* Supported. Perfect. Quiet success, perhaps w/ a brief FYI.

https://happygitwithr.com/common-remote-setups.html

Some live examples

```{r}
# usethis itself
proj_get()
classify_github_setup()
get_repo_spec()
get_primary_spec()
check_pr_readiness()

# a nice fork setup (I can't push to fork parent)
proj_set("~/tmp/map_excel_reprex/")
github_remotes2()
classify_github_setup()
get_repo_spec()
get_primary_spec()
check_pr_readiness()

# a nice fork setup (I can push to fork parent, a.k.a. The Lionel)
proj_set("~/rrr/httr")
github_remotes2()
classify_github_setup()
get_repo_spec()
get_primary_spec()
check_pr_readiness()

# a promising fork, but upstream not configured yet
proj_set("~/tmp/survminer/")
github_remotes2()
classify_github_setup()
get_repo_spec()
get_primary_spec()
check_pr_readiness()

# "theirs" <-- typical when someone clones but should fork-and-clone
proj_set("~/tmp/janitor/")
github_remotes2()
classify_github_setup()
get_repo_spec()
get_primary_spec()
check_pr_readiness()

x <- classify_github_setup()
stop_unsupported_pr_config(x)

# has no GitHub remotes
proj_set("~/tmp/ghu/")
github_remotes2()
classify_github_setup()
get_repo_spec()
get_primary_spec()
```

## Outlook for the transition

>100 functions involved

I'm about ~75% done

`pr_*()` functions and tracking branch issues are next / the final frontier

Suspect I need even more additions to gert

More internal polish/refactoring needed, e.g. re-abstracting into helpers

Messaging and interactive menus need refinement

Next group meeting: take it for a group test drive?
