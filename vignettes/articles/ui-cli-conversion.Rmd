---
title: "Converting usethis's UI to use cli"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(usethis)
```

# Review of the *status quo*

I'll start with a review of the current (soon to be legacy) `usethis::ui_*()` functions.

## Block styles

The block styles mostly exist to produce bulleted output with a specific symbol, using a specific color, that can be shutdown package-wide via the `usethis.quiet` option.

```{r}
f <- function() {
  ui_todo("ui_todo(): red bullet")
  ui_done("ui_done(): green check")
  ui_oops("ui_oops(): red x")
  ui_info("ui_info(): yellow i")
  ui_line("ui_line(): (no symbol)")
}
f()
```

These styles are very close to what can be done with `cli::cli_bullets()` and the way it responds to the names of its input `text`.

```{r}
cli::cli_bullets(c(
        "noindent",
  " " = "indent",
  "*" = "bullet",
  ">" = "arrow",
  "v" = "success",
  "x" = "danger",
  "!" = "warning",
  "i" = "info"
))
```

A direct translation looks something like this:

| `ui_*()`    | `cli_bullets()` shortcode | tweaks needed                 |
|-------------|---------------------------|-------------------------------|
| `ui_todo()` | `*`                       | blue (default) -\> red        |
| `ui_done()` | `v`                       | perfect match                 |
| `ui_oops()` | `x`                       | perfect match                 |
| `ui_info()` | `i`                       | blue (default) -\> yellow     |
| `ui_line()` | (unnamed)                 | might be perfect match? although sometimes ui_line is used just to get a blank line |

I'm experimenting with a few more tweaks related to TODOs:

-   Use `cli::symbol$checkbox_off` as the symbol (instead of a generic bullet). I guess it will continue to be red.
-   Introduce a new bullet shortcode for a TODO. Proposal: `_` (instead of `*`), which seems to be the best single ascii character that evokes a place to check something off.

That just leaves `code_block()`, which is pretty different.
It exists to put some code on the screen and optionally place it on the clipboard.
I have created a new function, `ui_code_snippet()` that is built around `cli::code_block()`.
Main observations:

* `cli::code_block(language = "R")` applies syntax highlighting and hyperlinks (e.g. to function help topics) to R code, which is cool. Therefore the `language` argument is also exposed in `ui_code_snippet()`, defaulting to `"R"`. Use `""` for anything that's not R code:
```{r}
#| eval: false
ui_code_snippet("x <- 1 + 2")
ui_code_snippet("#include <blah.h>", language = "")
```
* `ui_code_snippet()` takes a scalar glue-type template string or a vector of lines.
```{r}
ui_code_snippet("
  options(
    warnPartialMatchArgs = TRUE,
    warnPartialMatchDollar = TRUE,
    warnPartialMatchAttr = TRUE
  )")
# produces same result as
ui_code_snippet(c(
  "options(",
  "  warnPartialMatchArgs = TRUE,",
  "  warnPartialMatchDollar = TRUE,",
  "  warnPartialMatchAttr = TRUE",
  ")"))
```
* `ui_code_snippet()` does glue interpolation, by default, before calling `cli::cli_code()`, which means you have to think about your use of `{` and `}`. If you want literal `{` or `}`:
  - Use `interpolate = FALSE`, if you don't need interpolation.
  - Do the usual glue thing and double them, i.e. `{{` or `}}`.
  - If this becomes a real pain, open an issue/PR about adding `.open` and `.close` as arguments to `ui_code_snippet()`.

## Utility functions

The block style functions all route through some unexported utility functions.

`is_quiet()` just consults the `usethis.quiet` option and implements the default of `FALSE`.

```{r}
#| eval: false
is_quiet <- function() {
  isTRUE(getOption("usethis.quiet", default = FALSE))
}
```

`ui_todo()`, `ui_done()`, `ui_oops()`, `ui_info()` all route through `ui_bullet()`, which does some hygiene related to indentation (using the `indent()` utility function), then calls `ui_inform()`.
`ui_line()` and `ui_code()` call `ui_inform()` directly.

`ui_inform()` is just a wrapper around `rlang::inform()` that is guarded by a call to `is_quiet()`

```{r}
#| eval: false
ui_inform <- function(...) {
  if (!is_quiet()) {
    inform(paste0(...))
  }
  invisible()
}
```

Other than `is_quiet()`, which will continue to play the same role, I anticipate that we no longer need these utilities (`indent()`, `ui_bullet()`, `ui_inform()`).
Update: `indent()` turns out to still be useful in `ui_code_snippet()`.

Let's cover `ui_silence()` while we're here, which *is* exported.
It's just a `withr::with_*()` function for executing `code` with `usethis.quiet = TRUE`.

```{r}
#| eval: false
ui_silence <- function(code) {
  withr::with_options(list(usethis.quiet = TRUE), code)
}
```

## Inline styles

<https://cli.r-lib.org/reference/inline-markup.html>

-   `ui_field()` becomes `{.field blah}`. TO THINK ABOUT: I'm not seeing single quotes in the 'plain' snapshots, but I think we will want quoting if there's no color.
-   `ui_value()` becomes `{.val value}`
-   `ui_path()` is connected to `{.path path/to/thing}`, but `ui_path()` also has some legitimately useful logic, such as making a path relative to project root or ensuring a directory has a trailing `/`. Therefore, this has been abstracted into `ui_path_impl()`, which is aliased to `pth()` for compactness. Here's a typical conversion:
```{r}
#| eval: false
# using legacy functions
ui_done("Setting {ui_field('LazyData')} to \\
         {ui_value('true')} in {ui_path('DESCRIPTION')}")
# using new cli-based ui
ui_bullets(c(
  "v" = "Setting {.field LazyData} to {.val true} in {.path {pth('DESCRIPTION')}}."
))
```
It would be nice to create a custom inline class, e.g. `{.usethis_path {some_path}}`, which I have done in, e.g., googledrive. But it's not easy to this *while also inheriting cli's `file:` hyperlink behaviour*, which is very desirable. So that leads to the somewhat clunk pattern above, but it gives a nice result.
-   `ui_code()` gets replaced by various inline styles, depending on what the actual goal is:
    -   `{.arg some_argument}`
    -   `{.cls some_class}`
    -   `{.code some_text}`
    -   `{.envvar SOME_ENV_VAR}`
    -   `{.fun devtools::build_readme}`
    -   `{.help some_function}`
    -   `{.run some_code}`
    -   `{.topic some_topic}`
    -   `{.var variable_name}`

(I'll talk about `ui_unset()` below.)

## Conditions

I'm moving from `ui_stop()`:

```{r}
ui_stop <- function(x, .envir = parent.frame()) {
  x <- glue_collapse(x, "\n")
  x <- glue(x, .envir = .envir)

  cnd <- structure(
    class = c("usethis_error", "error", "condition"),
    list(message = x)
  )

  stop(cnd)
}
```

to `ui_abort()`:

```{r}
ui_abort <- function(message, ..., class = NULL, .envir = parent.frame()) {
  cli::cli_div(theme = usethis_theme())
  cli::cli_abort(
    message,
    class = c(class, "usethis_error"),
    .envir = .envir,
    ...
  )
}
```

At this point, the `usethis_theme()` doesn't do anything that affects the styling of an error.
So the main point of `ui_abort()` is to use to `cli_abort()` (and to continue applying the `"usethis_error"` class).

The legacy functions include `ui_warn()`:

```{r}
ui_warn <- function(x, .envir = parent.frame()) {
  x <- glue_collapse(x, "\n")
  x <- glue(x, .envir = .envir)

  warning(x, call. = FALSE, immediate. = TRUE)
}
```

It has very little usage and, instead of converting it, I'm going to eliminate its use altogether in favor of `ui_bullets(c("!" = "Thing I'm warning about."))
`.

## Sitrep and format helpers

This is a small clump of functions that support sitrep-type output.

-   `hd_line()`
-   `kv_line()`
-   `ui_unset()`

## Questions

There's currently no cli alternative to `ui_yeah()` and `ui_nope()`, so I won't make changes here.
