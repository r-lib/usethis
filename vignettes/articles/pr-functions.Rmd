---
title: "Pull request helpers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pull request helpers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
div.reviewer pre.r { background-color:#e3dece; }
div.output pre.r { background-color:#FFFFFF; }
</style>

The `pr_*` family of functions is designed to make working with GitHub [pull requests](https://help.github.com/en/articles/about-pull-requests) 
as painless as possible for both contributors and package maintainers. They are 
designed to support the Git and GitHub best practices described in 
[Happy Git and GitHub for the useR](http://happygitwithr.com/).

This vignette will walk you through a contribution to an R package via a pull 
request.

A pull request (PR) involves two players, a contributor and a reviewer.
In an effort to help keep straight who runs which code, the code chunks in this 
vignette are color coded: code by contributor appears in chunks with light gray 
background and code by reviewer appears in chunks with beige background.

```{r sample_contributor, eval=FALSE}
# contributor code
```
<div class = "reviewer">
```{r sample_reviewer, eval=FALSE}
# reviewer code
```
</div>

This vignette assumes that you have already gone through the 
[setup vignette](/articles/articles/usethis-setup). A good way to check that 
you are ready to use the `pr_*` family of functions is to run 
`usethis::git_sitrep()`, which prints info about your current Git, git2r, 
and GitHub setup.

## Set up advice

These functions make heavy use of git2r and the GitHub API. You'll need a GitHub 
personal access token (PAT); see `browse_github_token()` for help with that. If 
git2r does not seem to be finding your git credentials, read `git_credentials()` 
for troubleshooting advice. The transport protocol (SSH vs HTTPS) is determined 
from the existing remote URL(s) of the repo.

## Contributing via a pull request

So, you want to contribute to an R package? That's fantastic! 

In this vignette we'll walk through the process of making a pull request to the 
[**praise**](https://github.com/rladies/praise) package. This package is 
designed to help package developers _"build friendly R packages that praise their 
users if they have done something good, or they just need it to feel better."_ 
The package contains a series of positive adjectives, adverbs, verbs, smileys, 
and exclamations. In our pull request we will propose adding a new exclamation:
"yeah-yah".

### Fork and clone

The first step is to fork the source repository, and then check out a local 
copy. There are two ways you can do this, one is on GitHub by clicking on Fork, 
and the other is using `usethis::create_from_github`. We will focus on the latter.

If you have not previously contributed to this repository, chances are you have 
not forked it previously either. To first fork, and then clone your fork, use 
`usethis::create_from_github()` with the `fork` argument set to `TRUE`.

```{r create_from_github, eval=FALSE}
create_from_github(repo_spec = "rladies/praise", fork = TRUE)
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Creating '/Users/mine/Desktop/praise/'
#> ✔ Forking 'rladies/praise'
#> ✔ Cloning repo from 'git@github.com:mine-cetinkaya-rundel/praise.git' into # '/Users/mine/Desktop/praise'
#> ✔ Setting active project to '/Users/mine/Desktop/praise'
#> ✔ Adding 'upstream' remote: 'git@github.com:rladies/praise.git'
#> ✔ Pulling changes from GitHub source repo 'upstream/master'
#> ✔ Opening '/Users/mine/Desktop/praise/' in new RStudio session
```
</div>

This will create a folder on your Desktop (since we haven't specified an 
alternate location for `destdir`) with the same name as the package name, and 
forks and clones the package there. It also opens the package in an RStudio 
project in a new RStudio session. Note that the protocol used is `ssh` (we can 
tell that from the URL of the repo, which starts with `git@` as opposed to `https`).

### Begin contribution

We start the process of contributing to the package with `pr_init()`, which 
creates a branch in our repository for the pull request, as one should never 
submit a pull request from their master branch! We'll call this branch `"yeahyah"`.

```{r pr_init, eval=FALSE}
pr_init(branch = "yeahyah")
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Setting active project to '/Users/mine/Desktop/praise'
#> ✔ Checking that local branch 'master' has the changes in 'upstream/master'
#> ✔ Creating local PR branch 'yeahyah'
#> ✔ Switching to branch 'yeahyah'
#> ● Use `pr_push()` to create PR
```
</div>

A local branch called `yeahyah` is created and we switch to this branch. 
In RStudio, you will need to hit the refresh button in your Git pane to 
observe the that you have indeed been switched over to this branch. Now you can 
work locally, making changes to files and checking them into git. 

### Submit pull request

Let's go ahead and make the change, which is adding the word "yeahyah" to the 
`exclamation.R` file in the package. Below is the diff and the commit associated 
with this change.

```{r, echo = FALSE}
knitr::include_graphics("img/pr-functions-diff.png", dpi = 300)
```

You might spot that we made two mistakes here: (1) We intended to add "yeahyah" 
but added "yeahyeah" instead, ans (2) we forgot a comma at the end of the line. 
Let's assume we didn't actually catch these mistakes, and didn't build and check 
the package, which would have revelaed the lack of comma mistake, and initiate 
the process for submitting the PR with `pr_push()`.

```{r pr_push, eval=FALSE}
pr_push()
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Pushing local 'yeahyah' branch to 'origin:yeahyah'
#> ✔ Setting upstream tracking branch for 'yeahyah' to 'origin/yeahyah'
#> ✔ Create PR at link given below
#> ✔ Opening URL 'https://github.com/mine-cetinkaya-rundel/praise/compare/yeahyah'
```
</div>

This launches a browser window at the URL specified in the last message, which 
looks like the following.

```{r, echo = FALSE}
knitr::include_graphics("img/pr-functions-pull-request.png", dpi = 300)
```

Once we submit the pull request, GitHub will ping the package maintainer, and they will review our pull request. We can view this pull request in the browser with 
`pr_view()`. And anyone can follow along with it  [here](https://github.com/rladies/praise/pull/84).

```{r pr_view, eval=FALSE}
pr_view()
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Opening URL 'https://github.com/rladies/praise/pull/84'
```
</div>

### Review of the pull request

If we're lucky, and our pull request is perfect, the maintainer will accept it. 
However, in this case our it's not perfect. So the package maintainer leaves us 
comments requesting changes.

```{r, echo = FALSE}
knitr::include_graphics("img/pr-functions-comments.png", dpi = 300)
```

Being a somewhat careless contributor, we'll address one of these comments (fix 
spelling, but still make a mistake!) but not the other (forget to add the comma). 
We make the change, and commit it.

```{r, echo = FALSE}
knitr::include_graphics("img/pr-functions-address-comments.png", dpi = 300)
```

And then run `pr_push()` again to sync back up to GitHub.

```{r pr_push_again, eval=FALSE}
pr_push()
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Pushing local 'yeahyah' branch to 'origin:yeahyah'
#> ✔ Setting upstream tracking branch for 'yeahyah' to 'origin/yeahyah'
#> ✔ Create PR at link given below
#> ✔ Opening URL 'https://github.com/mine-cetinkaya-rundel/praise/compare/yeahyah'
```
</div>

Now the reviewer gets a chance to review our changes. At this point they might 
choose to just make the remaining changes and push their changes into our pull 
request to finish things up.

To do so, the reviewer will first fetch the PR with `pr_fetch`.

<div class = "reviewer">
```{r pr_fetch_reviewer, eval=FALSE}
usethis::pr_fetch(84)
```
</div>
<div class = "output">
```{r eval=FALSE}
#> ✔ Setting active project to '/Users/gaborcsardi/works/praise'
#> ✔ Checking out PR 'rladies/praise/#84' (@mine-cetinkaya-rundel): 'Add "yeahyah" to exclamations'
#> ✔ Creating local branch 'mine-cetinkaya-rundel-yeahyah'
#> ✔ Setting upstream tracking branch for 'mine-cetinkaya-rundel-yeahyah' to 'mine-cetinkaya-rundel/yeahyah'
#> ✔ Switching to branch 'mine-cetinkaya-rundel-yeahyah'
```
</div>

Fetching the PR creates a local branch for them called 
`mine-cetinkaya-rundel-yeahyah`, which is a text string comprised of the 
GitHub username of the contributor and the name of the branch they had created 
for this PR. `pr_fetch()` also then sets an upstream tracking branch 
for the local branch that got created and switches to that branch so the 
reviewer can make their changes on the correct branch.

Once the reviewer makes the necessary changes like fixing the spelling (again!) 
and adding the missing comma, and then run `pr_push()` to push their changes 
into our PR.

<div class = "reviewer">
```{r pr_push_reviewer, eval=FALSE}
usethis::pr_push()
```
</div>
<div class = "output">
```{r eval=FALSE}
#> ✔ Checking that local branch 'mine-cetinkaya-rundel-yeahyah' has the changes in 'mine-cetinkaya-rundel/yeahyah'
#> ✔ Pushing local 'mine-cetinkaya-rundel-yeahyah' branch to 'mine-cetinkaya-rundel:yeahyah'
#> ✔ View PR at 'https://github.com/rladies/praise/pull/84' or call `pr_view()`
```
</div>

### Wrap up

Finally, the reviewer merges our pull request on Github, and then and runs 
`pr_finish()` to switch back to the master branch and delete the local branch 
created during the process of interacting with our PR.

<div class = "reviewer">
```{r pr_finish_reviewer, eval=FALSE}
usethis::pr_finish()
```
</div>
<div class = "output">
```{r eval=FALSE}
#> ✔ Switching back to 'master' branch
#> ✔ Pulling changes from GitHub source repo 'origin/master'
#> ✔ Deleting local 'mine-cetinkaya-rundel-yeahyah' branch
#> ✔ Removing remote 'mine-cetinkaya-rundel'
```
</div>

Since the reviewer has contributed some code to our pull request, we can get 
that code back to our computer with `pr_pull()`.

```{r pr_pull, eval=FALSE}
pr_pull()
```
<div class = "output">
```{r eval=FALSE}
#> ✔ Pulling changes from GitHub PR
```
</div>

Finally we can finish the pull request process on our end with `pr_finish()` 
as well.

<div class = "reviewer">
```{r pr_finish_contributor, eval=FALSE}
usethis::pr_finish()
```
</div>
<div class = "output">
```{r eval=FALSE}
#> ✔ Switching back to 'master' branch
#> ✔ Pulling changes from GitHub source repo 'upstream/master'
#> ✔ Deleting local 'yeahyah' branch
```
</div>

At this point we can use the push button in the RStudio Git pane to push the 
last change (deletion of the local `yeahyah` branch) to GitHub so that we 
wrap up the PR with everything up-to-date!

## Other helpful functions

There are a few other functions in the `pr_*` family that we didn't encounter 
in this PR scenario:

- `pr_pull_upstream()` is used for getting changes that have occured in the 
package while we have been working on this PR, i.e. to "merge master".
This makes sure that our copy of the package is up-to-date with the maintainer's 
latest changes. 

- `pr_sync()` is a a helpful shortcut for pulling changes from the PR 
(`pr_pull()`), merging to master (`pr_pull_upstream()`) and pushing all these 
changes back into our PR (`pr_push()`). This series of actions might 
come in handy when working on an extensive PR that takes some time 
to develop while concurrently others are working on the project and making 
changes to the master branch.

- `pr_pause()` makes sure you're synced with the PR and then switches back to 
the master branch. This is likely something a package maintainer reviewing 
numerous PRs will need to use as they switch back and forth from 
review to working on master to another review.
